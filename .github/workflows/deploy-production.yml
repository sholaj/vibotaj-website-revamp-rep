name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'tracehub/**'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'Skip database backup'
        required: false
        default: 'false'
      skip_tests:
        description: 'Skip tests (emergency deploy only)'
        required: false
        default: 'false'

env:
  DEPLOY_PATH: /opt/tracehub-app/tracehub

jobs:
  # =============================================================================
  # TEST JOB - Runs backend tests before production deployment
  # CRITICAL: This prevents broken code from reaching production
  # =============================================================================
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: tracehub_test
          POSTGRES_PASSWORD: tracehub_test
          POSTGRES_DB: tracehub_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tracehub/backend/requirements.txt'

      - name: Install dependencies
        working-directory: tracehub/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        working-directory: tracehub/backend
        env:
          TEST_DATABASE_URL: postgresql://tracehub_test:tracehub_test@localhost:5432/tracehub_test
          JWT_SECRET: test-jwt-secret-for-ci
          TESTING: "true"
          CI: "true"
          DEBUG: "true"
        run: |
          pytest tests/ -v --tb=short --strict-markers

      - name: Test Summary
        if: always()
        run: |
          echo "## Production Pre-Deploy Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests must pass before production deployment." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # DEPLOY JOB - Only runs if tests pass (or are skipped for emergency)
  # =============================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    environment:
      name: production
      url: https://tracehub.vibotaj.com
    concurrency:
      group: production-deployment
      cancel-in-progress: false

    # Required permissions for deployment and issue creation
    permissions:
      contents: read
      issues: write

    steps:
      - name: Verify tests passed
        if: needs.test.result == 'skipped' && github.event.inputs.skip_tests == 'true'
        run: |
          echo "::warning::Tests were skipped for this deployment. This should only be used for emergencies."
          echo "## WARNING: Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "This production deployment skipped tests. Reason: Emergency deploy requested." >> $GITHUB_STEP_SUMMARY

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Try ssh-keyscan with retries and timeout
          for i in 1 2 3; do
            if ssh-keyscan -T 10 -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "Successfully added host to known_hosts"
              break
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          # Verify known_hosts is not empty
          if [ ! -s ~/.ssh/known_hosts ]; then
            echo "Warning: Could not get host key, adding insecure fallback"
            echo "StrictHostKeyChecking no" >> ~/.ssh/config
          fi
          chmod 600 ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create database backup
        if: github.event.inputs.skip_backup != 'true'
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            mkdir -p backups
            BACKUP_FILE=backups/backup_$(date +%Y%m%d_%H%M%S).sql
            if docker ps | grep -q tracehub-db; then
              docker exec tracehub-db pg_dump -U tracehub tracehub > ${BACKUP_FILE}
              gzip ${BACKUP_FILE}
              echo "Backup created: ${BACKUP_FILE}.gz"

              # Keep only last 10 backups
              ls -t backups/backup_*.sql.gz 2>/dev/null | tail -n +11 | xargs -r rm
            else
              echo "Database not running, skipping backup"
            fi
          ENDSSH

      - name: Sync code to server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='uploads/*' \
            --exclude='logs/*' \
            --exclude='backups/*' \
            ./tracehub/ \
            ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Update .env file
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            cat > .env << 'EOF'
          ENVIRONMENT=production
          DATABASE_URL=postgresql://tracehub:${{ secrets.PRODUCTION_DB_PASSWORD }}@db:5432/tracehub
          JWT_SECRET=${{ secrets.PRODUCTION_JWT_SECRET }}
          JSONCARGO_API_KEY=${{ secrets.JSONCARGO_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          DEMO_PASSWORD=${{ secrets.DEMO_PASSWORD }}
          CORS_ORIGINS=["https://tracehub.vibotaj.com","http://localhost:3000"]
          DEBUG=false
          EOF
            # Remove leading whitespace from .env file
            sed -i 's/^[[:space:]]*//' .env
          ENDSSH

      - name: Setup SSL certificates
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            # Check if certificates exist
            if [ ! -f /etc/letsencrypt/live/tracehub.vibotaj.com/fullchain.pem ]; then
              echo "SSL certificates not found, generating with certbot..."

              # Install certbot if not present
              if ! command -v certbot &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y certbot
              fi

              # Stop any services using port 80
              cd ${{ env.DEPLOY_PATH }}
              docker compose stop frontend || true

              # Generate certificate using standalone mode
              sudo certbot certonly --standalone \
                --non-interactive \
                --agree-tos \
                --email admin@vibotaj.com \
                -d tracehub.vibotaj.com \
                || echo "Certbot failed, check logs"

              echo "Certificate generation complete"
              ls -la /etc/letsencrypt/live/tracehub.vibotaj.com/ || echo "Cert dir not found"
            else
              echo "SSL certificates already exist"
              # Check expiry
              sudo certbot certificates | grep -A2 "tracehub.vibotaj.com" || true
            fi
          ENDSSH

      - name: Rebuild and restart containers
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}

            # Build new images
            docker compose build --no-cache backend frontend

            # Restart services (db stays running)
            docker compose up -d --force-recreate backend frontend

            # Wait for services to start
            sleep 10

            # Check health
            docker compose ps
          ENDSSH

      - name: Run database migrations
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}

            # Check if alembic is set up
            if [ -f backend/alembic.ini ]; then
              docker compose exec -T backend alembic upgrade head || echo "Migration skipped or failed"
            else
              echo "Alembic not configured, skipping migrations"
            fi
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 5

          # Test backend health
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "curl -sf http://localhost:8000/health || echo 'Backend health check failed'"

          # Test API endpoint
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "curl -sf http://localhost:8000/api/shipments | head -c 100 || echo 'API check failed'"

          echo "Deployment verification complete"

      - name: Clean up old images
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            docker image prune -f
          ENDSSH

      - name: Deployment summary
        run: |
          echo "## Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://tracehub.vibotaj.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Production Deployment Failed',
              body: `Production deployment failed for commit ${context.sha}\n\nWorkflow: ${context.workflow}\nRun: ${context.runNumber}\n\n**Action Required**: Check logs and consider rollback.`,
              labels: ['deployment', 'bug']
            })
