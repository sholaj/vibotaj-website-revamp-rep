name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/tracehub/staging

jobs:
  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.tracehub.vibotaj.com
    concurrency:
      group: staging-deployment
      cancel-in-progress: false

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          for i in 1 2 3; do
            if ssh-keyscan -T 10 -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "Successfully added host to known_hosts"
              break
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          if [ ! -s ~/.ssh/known_hosts ]; then
            echo "Warning: Could not get host key, adding insecure fallback"
            echo "StrictHostKeyChecking no" >> ~/.ssh/config
          fi
          chmod 600 ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create staging directory
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"

      - name: Sync code to server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='uploads/*' \
            --exclude='logs/*' \
            --exclude='backups/*' \
            ./tracehub/ \
            ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Update .env file
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            cat > .env << 'EOF'
          ENVIRONMENT=staging
          DB_USER=tracehub_staging
          DB_PASSWORD=${{ secrets.PRODUCTION_DB_PASSWORD }}
          DB_NAME=tracehub_staging
          DB_PORT=5532
          JWT_SECRET=${{ secrets.PRODUCTION_JWT_SECRET }}
          VIZION_API_KEY=${{ secrets.VIZION_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          DEMO_PASSWORD=${{ secrets.DEMO_PASSWORD }}
          DEBUG=true
          CORS_ORIGINS=["https://staging.tracehub.vibotaj.com","http://localhost:3100"]
          BACKEND_PORT=8100
          FRONTEND_PORT=3100
          EOF
            sed -i 's/^[[:space:]]*//' .env
          ENDSSH

      - name: Rebuild and restart containers
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}

            # Use staging-specific docker-compose file
            export COMPOSE_FILE=docker-compose.staging.yml

            # Build new images
            docker compose build --no-cache backend frontend

            # Restart services
            docker compose up -d --force-recreate

            # Wait for services to start
            sleep 10

            # Check health
            docker compose ps
          ENDSSH

      - name: Run database migrations
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            export COMPOSE_FILE=docker-compose.staging.yml

            if [ -f backend/alembic.ini ]; then
              docker compose exec -T backend alembic upgrade head || echo "Migration skipped or failed"
            else
              echo "Alembic not configured, skipping migrations"
            fi
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 5

          # Test staging backend health (port 8100)
          if ! ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "curl -sf http://localhost:8100/health"; then
            echo "Backend health check failed - collecting logs..."
            ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
              cd /home/tracehub/staging
              export COMPOSE_FILE=docker-compose.staging.yml
              echo "=== Container Status ==="
              docker compose ps -a
              echo "=== Backend Logs ==="
              docker compose logs --tail=100 backend || echo "No backend logs"
              echo "=== DB Logs ==="
              docker compose logs --tail=20 db || echo "No db logs"
          ENDSSH
            exit 1
          fi

          # Test staging frontend health (port 3100)
          if ! ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "curl -sf http://localhost:3100/health"; then
            echo "Frontend health check failed - collecting logs..."
            ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
              cd /home/tracehub/staging
              export COMPOSE_FILE=docker-compose.staging.yml
              echo "=== Container Status ==="
              docker compose ps -a
              echo "=== Frontend Logs ==="
              docker compose logs --tail=100 frontend || echo "No frontend logs"
          ENDSSH
            exit 1
          fi

          echo "Staging deployment verification complete"

      - name: Clean up old images
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            docker image prune -f
          ENDSSH

      - name: Deployment summary
        run: |
          echo "## Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: develop" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: staging" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://staging.tracehub.vibotaj.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Staging Deployment Failed',
              body: `Staging deployment failed for commit ${context.sha}\n\nWorkflow: ${context.workflow}\nRun: ${context.runNumber}`,
              labels: ['deployment', 'staging', 'bug']
            })
